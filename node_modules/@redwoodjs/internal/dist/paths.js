"use strict";

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js/object/define-property");

_Object$defineProperty(exports, "__esModule", {
  value: true
});

exports.processPagesDir = exports.getPaths = exports.resolveFile = exports.getBaseDir = exports.getConfigPath = void 0;

var _forEach = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/instance/for-each"));

var _path = _interopRequireDefault(require("path"));

var _fs = _interopRequireDefault(require("fs"));

var _findupSync = _interopRequireDefault(require("findup-sync"));

const CONFIG_FILE_NAME = 'redwood.toml';
const PATH_API_DIR_FUNCTIONS = 'api/src/functions';
const PATH_API_DIR_GRAPHQL = 'api/src/graphql';
const PATH_API_DIR_DB = 'api/prisma';
const PATH_API_DIR_DB_SCHEMA = 'api/prisma/schema.prisma';
const PATH_API_DIR_CONFIG = 'api/src/config';
const PATH_API_DIR_LIB = 'api/src/lib';
const PATH_API_DIR_SERVICES = 'api/src/services';
const PATH_API_DIR_SRC = 'api/src';
const PATH_WEB_ROUTES = 'web/src/Routes'; // .js|.tsx

const PATH_WEB_DIR_LAYOUTS = 'web/src/layouts/';
const PATH_WEB_DIR_PAGES = 'web/src/pages/';
const PATH_WEB_DIR_COMPONENTS = 'web/src/components';
const PATH_WEB_DIR_SRC = 'web/src';
const PATH_WEB_DIR_CONFIG = 'web/config';
const PATH_WEB_DIR_CONFIG_WEBPACK = 'web/config/webpack.config.js';
/**
 * Search the parent directories for the Redwood configuration file.
 */

const getConfigPath = () => {
  const configPath = (0, _findupSync.default)(CONFIG_FILE_NAME);

  if (!configPath) {
    throw new Error(`Could not find a "${CONFIG_FILE_NAME}" file, are you sure you're in a Redwood project?`);
  }

  return configPath;
};
/**
 * The Redwood config file is used as an anchor for the base directory of a project.
 */


exports.getConfigPath = getConfigPath;

const getBaseDir = (configPath = getConfigPath()) => {
  return _path.default.dirname(configPath);
};
/**
 * Use this to resolve files when the path to the file is known, but the extension
 * is not.
 */


exports.getBaseDir = getBaseDir;

const resolveFile = (filePath, extensions = ['.js', '.tsx', '.ts']) => {
  for (const extension of extensions) {
    const p = `${filePath}${extension}`;

    if (_fs.default.existsSync(p)) {
      return p;
    }
  }

  return null;
};
/**
 * Path constants that are relevant to a Redwood project.
 */


exports.resolveFile = resolveFile;

const getPaths = (BASE_DIR = getBaseDir()) => {
  const routes = resolveFile(_path.default.join(BASE_DIR, PATH_WEB_ROUTES));
  return {
    base: BASE_DIR,
    api: {
      base: _path.default.join(BASE_DIR, 'api'),
      db: _path.default.join(BASE_DIR, PATH_API_DIR_DB),
      dbSchema: _path.default.join(BASE_DIR, PATH_API_DIR_DB_SCHEMA),
      functions: _path.default.join(BASE_DIR, PATH_API_DIR_FUNCTIONS),
      graphql: _path.default.join(BASE_DIR, PATH_API_DIR_GRAPHQL),
      lib: _path.default.join(BASE_DIR, PATH_API_DIR_LIB),
      config: _path.default.join(BASE_DIR, PATH_API_DIR_CONFIG),
      services: _path.default.join(BASE_DIR, PATH_API_DIR_SERVICES),
      src: _path.default.join(BASE_DIR, PATH_API_DIR_SRC)
    },
    web: {
      routes,
      base: _path.default.join(BASE_DIR, 'web'),
      pages: _path.default.join(BASE_DIR, PATH_WEB_DIR_PAGES),
      components: _path.default.join(BASE_DIR, PATH_WEB_DIR_COMPONENTS),
      layouts: _path.default.join(BASE_DIR, PATH_WEB_DIR_LAYOUTS),
      src: _path.default.join(BASE_DIR, PATH_WEB_DIR_SRC),
      config: _path.default.join(BASE_DIR, PATH_WEB_DIR_CONFIG),
      webpack: _path.default.join(BASE_DIR, PATH_WEB_DIR_CONFIG_WEBPACK)
    }
  };
};
/**
 * Recursively process the pages directory and return information useful for
 * automated imports.
 */


exports.getPaths = getPaths;

const processPagesDir = (webPagesDir = getPaths().web.pages, prefix = []) => {
  const deps = [];

  const entries = _fs.default.readdirSync(webPagesDir, {
    withFileTypes: true
  }); // Iterate over a dir's entries, recursing as necessary into
  // subdirectories.


  (0, _forEach.default)(entries).call(entries, entry => {
    if (entry.isDirectory()) {
      try {
        // Actual page js or tsx files reside in a directory of the same
        // name (supported by: directory-named-webpack-plugin), so let's
        // construct the filename of the actual Page file.
        // `require.resolve` will throw if a module cannot be found.
        const importPath = _path.default.join(webPagesDir, entry.name, entry.name);

        require.resolve(importPath); // If the Page exists, then construct the dependency object and push it
        // onto the deps array.


        const basename = _path.default.posix.basename(entry.name);

        const importName = prefix.join() + basename; // `src/pages/<PageName>`

        const importFile = ['src', 'pages', ...prefix, basename].join('/');
        deps.push({
          importName,
          importPath,
          const: importName,
          path: _path.default.join(webPagesDir, entry.name),
          importStatement: `const ${importName.split(',').join('')} = { name: '${importName.split(',').join('')}', loader: () => import('${importFile}') }`
        });
      } catch (e) {
        // If the Page doesn't exist then we are in a directory of Page
        // directories, so let's recurse into it and do the whole thing over
        // again.
        const newPrefix = [...prefix, entry.name];
        deps.push(...processPagesDir(_path.default.join(webPagesDir, entry.name), newPrefix));
      }
    }
  });
  return deps;
};

exports.processPagesDir = processPagesDir;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wYXRocy50cyJdLCJuYW1lcyI6WyJDT05GSUdfRklMRV9OQU1FIiwiUEFUSF9BUElfRElSX0ZVTkNUSU9OUyIsIlBBVEhfQVBJX0RJUl9HUkFQSFFMIiwiUEFUSF9BUElfRElSX0RCIiwiUEFUSF9BUElfRElSX0RCX1NDSEVNQSIsIlBBVEhfQVBJX0RJUl9DT05GSUciLCJQQVRIX0FQSV9ESVJfTElCIiwiUEFUSF9BUElfRElSX1NFUlZJQ0VTIiwiUEFUSF9BUElfRElSX1NSQyIsIlBBVEhfV0VCX1JPVVRFUyIsIlBBVEhfV0VCX0RJUl9MQVlPVVRTIiwiUEFUSF9XRUJfRElSX1BBR0VTIiwiUEFUSF9XRUJfRElSX0NPTVBPTkVOVFMiLCJQQVRIX1dFQl9ESVJfU1JDIiwiUEFUSF9XRUJfRElSX0NPTkZJRyIsIlBBVEhfV0VCX0RJUl9DT05GSUdfV0VCUEFDSyIsImdldENvbmZpZ1BhdGgiLCJjb25maWdQYXRoIiwiRXJyb3IiLCJnZXRCYXNlRGlyIiwicGF0aCIsImRpcm5hbWUiLCJyZXNvbHZlRmlsZSIsImZpbGVQYXRoIiwiZXh0ZW5zaW9ucyIsImV4dGVuc2lvbiIsInAiLCJmcyIsImV4aXN0c1N5bmMiLCJnZXRQYXRocyIsIkJBU0VfRElSIiwicm91dGVzIiwiam9pbiIsImJhc2UiLCJhcGkiLCJkYiIsImRiU2NoZW1hIiwiZnVuY3Rpb25zIiwiZ3JhcGhxbCIsImxpYiIsImNvbmZpZyIsInNlcnZpY2VzIiwic3JjIiwid2ViIiwicGFnZXMiLCJjb21wb25lbnRzIiwibGF5b3V0cyIsIndlYnBhY2siLCJwcm9jZXNzUGFnZXNEaXIiLCJ3ZWJQYWdlc0RpciIsInByZWZpeCIsImRlcHMiLCJlbnRyaWVzIiwicmVhZGRpclN5bmMiLCJ3aXRoRmlsZVR5cGVzIiwiZW50cnkiLCJpc0RpcmVjdG9yeSIsImltcG9ydFBhdGgiLCJuYW1lIiwicmVxdWlyZSIsInJlc29sdmUiLCJiYXNlbmFtZSIsInBvc2l4IiwiaW1wb3J0TmFtZSIsImltcG9y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RXZCcEMsSUFGdUIsQ0FFbEIsRUFGa0IsQ0FFZCw0QkFBMkJnQyxVQUFXO0FBVDFDLFNBQVY7QUFXRCxPQXpCRCxDQXlCRSxPQUFPSyxDQUFQLEVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQSxjQUFNQyxTQUFTLEdBQUcsQ0FBQyxHQUFHcEIsTUFBSixFQUFZSyxLQUFLLENBQUNHLElBQWxCLENBQWxCO0FBQ0FQLFFBQUFBLElBQUksQ0FBQ2MsSUFBTCxDQUNFLEdBQUdqQixlQUFlLENBQUM1QixjQUFLWSxJQUFMLENBQVVpQixXQUFWLEVBQXVCTSxLQUFLLENBQUNHLElBQTdCLENBQUQsRUFBcUNZLFNBQXJDLENBRHBCO0FBR0Q7QUFDRjtBQUNGLEdBckNNLENBQVA7QUFzQ0EsU0FBT25CLElBQVA7QUFDRCxDQWhETSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgZnMgZnJvbSAnZnMnXG5cbmltcG9ydCBmaW5kVXAgZnJvbSAnZmluZHVwLXN5bmMnXG5cbmV4cG9ydCBpbnRlcmZhY2UgTm9kZVRhcmdldFBhdGhzIHtcbiAgYmFzZTogc3RyaW5nXG4gIGRiOiBzdHJpbmdcbiAgZGJTY2hlbWE6IHN0cmluZ1xuICBzcmM6IHN0cmluZ1xuICBmdW5jdGlvbnM6IHN0cmluZ1xuICBncmFwaHFsOiBzdHJpbmdcbiAgbGliOiBzdHJpbmdcbiAgc2VydmljZXM6IHN0cmluZ1xuICBjb25maWc6IHN0cmluZ1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEJyb3dzZXJUYXJnZXRQYXRocyB7XG4gIGJhc2U6IHN0cmluZ1xuICBzcmM6IHN0cmluZ1xuICByb3V0ZXM6IHN0cmluZ1xuICBwYWdlczogc3RyaW5nXG4gIGNvbXBvbmVudHM6IHN0cmluZ1xuICBsYXlvdXRzOiBzdHJpbmdcbiAgY29uZmlnOiBzdHJpbmdcbiAgd2VicGFjazogc3RyaW5nXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGF0aHMge1xuICBiYXNlOiBzdHJpbmdcbiAgd2ViOiBCcm93c2VyVGFyZ2V0UGF0aHNcbiAgYXBpOiBOb2RlVGFyZ2V0UGF0aHNcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQYWdlc0RlcGVuZGVuY3kge1xuICBpbXBvcnROYW1lOiBzdHJpbmdcbiAgaW1wb3J0UGF0aDogc3RyaW5nXG4gIGNvbnN0OiBzdHJpbmdcbiAgcGF0aDogc3RyaW5nXG4gIGltcG9ydFN0YXRlbWVudDogc3RyaW5nXG59XG5cbmNvbnN0IENPTkZJR19GSUxFX05BTUUgPSAncmVkd29vZC50b21sJ1xuXG5jb25zdCBQQVRIX0FQSV9ESVJfRlVOQ1RJT05TID0gJ2FwaS9zcmMvZnVuY3Rpb25zJ1xuY29uc3QgUEFUSF9BUElfRElSX0dSQVBIUUwgPSAnYXBpL3NyYy9ncmFwaHFsJ1xuY29uc3QgUEFUSF9BUElfRElSX0RCID0gJ2FwaS9wcmlzbWEnXG5jb25zdCBQQVRIX0FQSV9ESVJfREJfU0NIRU1BID0gJ2FwaS9wcmlzbWEvc2NoZW1hLnByaXNtYSdcbmNvbnN0IFBBVEhfQVBJX0RJUl9DT05GSUcgPSAnYXBpL3NyYy9jb25maWcnXG5jb25zdCBQQVRIX0FQSV9ESVJfTElCID0gJ2FwaS9zcmMvbGliJ1xuY29uc3QgUEFUSF9BUElfRElSX1NFUlZJQ0VTID0gJ2FwaS9zcmMvc2VydmljZXMnXG5jb25zdCBQQVRIX0FQSV9ESVJfU1JDID0gJ2FwaS9zcmMnXG5jb25zdCBQQVRIX1dFQl9ST1VURVMgPSAnd2ViL3NyYy9Sb3V0ZXMnIC8vIC5qc3wudHN4XG5jb25zdCBQQVRIX1dFQl9ESVJfTEFZT1VUUyA9ICd3ZWIvc3JjL2xheW91dHMvJ1xuY29uc3QgUEFUSF9XRUJfRElSX1BBR0VTID0gJ3dlYi9zcmMvcGFnZXMvJ1xuY29uc3QgUEFUSF9XRUJfRElSX0NPTVBPTkVOVFMgPSAnd2ViL3NyYy9jb21wb25lbnRzJ1xuY29uc3QgUEFUSF9XRUJfRElSX1NSQyA9ICd3ZWIvc3JjJ1xuY29uc3QgUEFUSF9XRUJfRElSX0NPTkZJRyA9ICd3ZWIvY29uZmlnJ1xuY29uc3QgUEFUSF9XRUJfRElSX0NPTkZJR19XRUJQQUNLID0gJ3dlYi9jb25maWcvd2VicGFjay5jb25maWcuanMnXG5cbi8qKlxuICogU2VhcmNoIHRoZSBwYXJlbnQgZGlyZWN0b3JpZXMgZm9yIHRoZSBSZWR3b29kIGNvbmZpZ3VyYXRpb24gZmlsZS5cbiAqL1xuZXhwb3J0IGNvbnN0IGdldENvbmZpZ1BhdGggPSAoKTogc3RyaW5nID0+IHtcbiAgY29uc3QgY29uZmlnUGF0aCA9IGZpbmRVcChDT05GSUdfRklMRV9OQU1FKVxuICBpZiAoIWNvbmZpZ1BhdGgpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgQ291bGQgbm90IGZpbmQgYSBcIiR7Q09ORklHX0ZJTEVfTkFNRX1cIiBmaWxlLCBhcmUgeW91IHN1cmUgeW91J3JlIGluIGEgUmVkd29vZCBwcm9qZWN0P2BcbiAgICApXG4gIH1cbiAgcmV0dXJuIGNvbmZpZ1BhdGhcbn1cblxuLyoqXG4gKiBUaGUgUmVkd29vZCBjb25maWcgZmlsZSBpcyB1c2VkIGFzIGFuIGFuY2hvciBmb3IgdGhlIGJhc2UgZGlyZWN0b3J5IG9mIGEgcHJvamVjdC5cbiAqL1xuZXhwb3J0IGNvbnN0IGdldEJhc2VEaXIgPSAoY29uZmlnUGF0aDogc3RyaW5nID0gZ2V0Q29uZmlnUGF0aCgpKTogc3RyaW5nID0+IHtcbiAgcmV0dXJuIHBhdGguZGlybmFtZShjb25maWdQYXRoKVxufVxuXG4vKipcbiAqIFVzZSB0aGlzIHRvIHJlc29sdmUgZmlsZXMgd2hlbiB0aGUgcGF0aCB0byB0aGUgZmlsZSBpcyBrbm93biwgYnV0IHRoZSBleHRlbnNpb25cbiAqIGlzIG5vdC5cbiAqL1xuZXhwb3J0IGNvbnN0IHJlc29sdmVGaWxlID0gKFxuICBmaWxlUGF0aDogc3RyaW5nLFxuICBleHRlbnNpb25zOiBzdHJpbmdbXSA9IFsnLmpzJywgJy50c3gnLCAnLnRzJ11cbik6IHN0cmluZyB8IG51bGwgPT4ge1xuICBmb3IgKGNvbnN0IGV4dGVuc2lvbiBvZiBleHRlbnNpb25zKSB7XG4gICAgY29uc3QgcCA9IGAke2ZpbGVQYXRofSR7ZXh0ZW5zaW9ufWBcbiAgICBpZiAoZnMuZXhpc3RzU3luYyhwKSkge1xuICAgICAgcmV0dXJuIHBcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG51bGxcbn1cblxuLyoqXG4gKiBQYXRoIGNvbnN0YW50cyB0aGF0IGFyZSByZWxldmFudCB0byBhIFJlZHdvb2QgcHJvamVjdC5cbiAqL1xuZXhwb3J0IGNvbnN0IGdldFBhdGhzID0gKEJBU0VfRElSOiBzdHJpbmcgPSBnZXRCYXNlRGlyKCkpOiBQYXRocyA9PiB7XG4gIGNvbnN0IHJvdXRlcyA9IHJlc29sdmVGaWxlKHBhdGguam9pbihCQVNFX0RJUiwgUEFUSF9XRUJfUk9VVEVTKSkgYXMgc3RyaW5nXG5cbiAgcmV0dXJuIHtcbiAgICBiYXNlOiBCQVNFX0RJUixcbiAgICBhcGk6IHtcbiAgICAgIGJhc2U6IHBhdGguam9pbihCQVNFX0RJUiwgJ2FwaScpLFxuICAgICAgZGI6IHBhdGguam9pbihCQVNFX0RJUiwgUEFUSF9BUElfRElSX0RCKSxcbiAgICAgIGRiU2NoZW1hOiBwYXRoLmpvaW4oQkFTRV9ESVIsIFBBVEhfQVBJX0RJUl9EQl9TQ0hFTUEpLFxuICAgICAgZnVuY3Rpb25zOiBwYXRoLmpvaW4oQkFTRV9ESVIsIFBBVEhfQVBJX0RJUl9GVU5DVElPTlMpLFxuICAgICAgZ3JhcGhxbDogcGF0aC5qb2luKEJBU0VfRElSLCBQQVRIX0FQSV9ESVJfR1JBUEhRTCksXG4gICAgICBsaWI6IHBhdGguam9pbihCQVNFX0RJUiwgUEFUSF9BUElfRElSX0xJQiksXG4gICAgICBjb25maWc6IHBhdGguam9pbihCQVNFX0RJUiwgUEFUSF9BUElfRElSX0NPTkZJRyksXG4gICAgICBzZXJ2aWNlczogcGF0aC5qb2luKEJBU0VfRElSLCBQQVRIX0FQSV9ESVJfU0VSVklDRVMpLFxuICAgICAgc3JjOiBwYXRoLmpvaW4oQkFTRV9ESVIsIFBBVEhfQVBJX0RJUl9TUkMpLFxuICAgIH0sXG4gICAgd2ViOiB7XG4gICAgICByb3V0ZXMsXG4gICAgICBiYXNlOiBwYXRoLmpvaW4oQkFTRV9ESVIsICd3ZWInKSxcbiAgICAgIHBhZ2VzOiBwYXRoLmpvaW4oQkFTRV9ESVIsIFBBVEhfV0VCX0RJUl9QQUdFUyksXG4gICAgICBjb21wb25lbnRzOiBwYXRoLmpvaW4oQkFTRV9ESVIsIFBBVEhfV0VCX0RJUl9DT01QT05FTlRTKSxcbiAgICAgIGxheW91dHM6IHBhdGguam9pbihCQVNFX0RJUiwgUEFUSF9XRUJfRElSX0xBWU9VVFMpLFxuICAgICAgc3JjOiBwYXRoLmpvaW4oQkFTRV9ESVIsIFBBVEhfV0VCX0RJUl9TUkMpLFxuICAgICAgY29uZmlnOiBwYXRoLmpvaW4oQkFTRV9ESVIsIFBBVEhfV0VCX0RJUl9DT05GSUcpLFxuICAgICAgd2VicGFjazogcGF0aC5qb2luKEJBU0VfRElSLCBQQVRIX1dFQl9ESVJfQ09ORklHX1dFQlBBQ0spLFxuICAgIH0sXG4gIH1cbn1cblxuLyoqXG4gKiBSZWN1cnNpdmVseSBwcm9jZXNzIHRoZSBwYWdlcyBkaXJlY3RvcnkgYW5kIHJldHVybiBpbmZvcm1hdGlvbiB1c2VmdWwgZm9yXG4gKiBhdXRvbWF0ZWQgaW1wb3J0cy5cbiAqL1xuZXhwb3J0IGNvbnN0IHByb2Nlc3NQYWdlc0RpciA9IChcbiAgd2ViUGFnZXNEaXI6IHN0cmluZyA9IGdldFBhdGhzKCkud2ViLnBhZ2VzLFxuICBwcmVmaXg6IEFycmF5PHN0cmluZz4gPSBbXVxuKTogQXJyYXk8UGFnZXNEZXBlbmRlbmN5PiA9PiB7XG4gIGNvbnN0IGRlcHM6IEFycmF5PFBhZ2VzRGVwZW5kZW5jeT4gPSBbXVxuICBjb25zdCBlbnRyaWVzID0gZnMucmVhZGRpclN5bmMod2ViUGFnZXNEaXIsIHsgd2l0aEZpbGVUeXBlczogdHJ1ZSB9KVxuXG4gIC8vIEl0ZXJhdGUgb3ZlciBhIGRpcidzIGVudHJpZXMsIHJlY3Vyc2luZyBhcyBuZWNlc3NhcnkgaW50b1xuICAvLyBzdWJkaXJlY3Rvcmllcy5cbiAgZW50cmllcy5mb3JFYWNoKChlbnRyeSkgPT4ge1xuICAgIGlmIChlbnRyeS5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICB0cnkge1xuICAgICAgICAvLyBBY3R1YWwgcGFnZSBqcyBvciB0c3ggZmlsZXMgcmVzaWRlIGluIGEgZGlyZWN0b3J5IG9mIHRoZSBzYW1lXG4gICAgICAgIC8vIG5hbWUgKHN1cHBvcnRlZCBieTogZGlyZWN0b3J5LW5hbWVkLXdlYnBhY2stcGx1Z2luKSwgc28gbGV0J3NcbiAgICAgICAgLy8gY29uc3RydWN0IHRoZSBmaWxlbmFtZSBvZiB0aGUgYWN0dWFsIFBhZ2UgZmlsZS5cbiAgICAgICAgLy8gYHJlcXVpcmUucmVzb2x2ZWAgd2lsbCB0aHJvdyBpZiBhIG1vZHVsZSBjYW5ub3QgYmUgZm91bmQuXG4gICAgICAgIGNvbnN0IGltcG9ydFBhdGggPSBwYXRoLmpvaW4od2ViUGFnZXNEaXIsIGVudHJ5Lm5hbWUsIGVudHJ5Lm5hbWUpXG4gICAgICAgIHJlcXVpcmUucmVzb2x2ZShpbXBvcnRQYXRoKVxuXG4gICAgICAgIC8vIElmIHRoZSBQYWdlIGV4aXN0cywgdGhlbiBjb25zdHJ1Y3QgdGhlIGRlcGVuZGVuY3kgb2JqZWN0IGFuZCBwdXNoIGl0XG4gICAgICAgIC8vIG9udG8gdGhlIGRlcHMgYXJyYXkuXG4gICAgICAgIGNvbnN0IGJhc2VuYW1lID0gcGF0aC5wb3NpeC5iYXNlbmFtZShlbnRyeS5uYW1lKVxuICAgICAgICBjb25zdCBpbXBvcnROYW1lID0gcHJlZml4LmpvaW4oKSArIGJhc2VuYW1lXG4gICAgICAgIC8vIGBzcmMvcGFnZXMvPFBhZ2VOYW1lPmBcbiAgICAgICAgY29uc3QgaW1wb3J0RmlsZSA9IFsnc3JjJywgJ3BhZ2VzJywgLi4ucHJlZml4LCBiYXNlbmFtZV0uam9pbignLycpXG4gICAgICAgIGRlcHMucHVzaCh7XG4gICAgICAgICAgaW1wb3J0TmFtZSxcbiAgICAgICAgICBpbXBvcnRQYXRoLFxuICAgICAgICAgIGNvbnN0OiBpbXBvcnROYW1lLFxuICAgICAgICAgIHBhdGg6IHBhdGguam9pbih3ZWJQYWdlc0RpciwgZW50cnkubmFtZSksXG4gICAgICAgICAgaW1wb3J0U3RhdGVtZW50OiBgY29uc3QgJHtpbXBvcnROYW1lXG4gICAgICAgICAgICAuc3BsaXQoJywnKVxuICAgICAgICAgICAgLmpvaW4oJycpfSA9IHsgbmFtZTogJyR7aW1wb3J0TmFtZVxuICAgICAgICAgICAgLnNwbGl0KCcsJylcbiAgICAgICAgICAgIC5qb2luKCcnKX0nLCBsb2FkZXI6ICgpID0+IGltcG9ydCgnJHtpbXBvcnRGaWxlfScpIH1gLFxuICAgICAgICB9KVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAvLyBJZiB0aGUgUGFnZSBkb2Vzbid0IGV4aXN0IHRoZW4gd2UgYXJlIGluIGEgZGlyZWN0b3J5IG9mIFBhZ2VcbiAgICAgICAgLy8gZGlyZWN0b3JpZXMsIHNvIGxldCdzIHJlY3Vyc2UgaW50byBpdCBhbmQgZG8gdGhlIHdob2xlIHRoaW5nIG92ZXJcbiAgICAgICAgLy8gYWdhaW4uXG4gICAgICAgIGNvbnN0IG5ld1ByZWZpeCA9IFsuLi5wcmVmaXgsIGVudHJ5Lm5hbWVdXG4gICAgICAgIGRlcHMucHVzaChcbiAgICAgICAgICAuLi5wcm9jZXNzUGFnZXNEaXIocGF0aC5qb2luKHdlYlBhZ2VzRGlyLCBlbnRyeS5uYW1lKSwgbmV3UHJlZml4KVxuICAgICAgICApXG4gICAgICB9XG4gICAgfVxuICB9KVxuICByZXR1cm4gZGVwc1xufVxuIl19