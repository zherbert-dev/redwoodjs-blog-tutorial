"use strict";

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js/object/define-property");

_Object$defineProperty(exports, "__esModule", {
  value: true
});

exports.requestHandler = exports.parseBody = void 0;

var _stringify = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/json/stringify"));

var _keys = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/object/keys"));

var _forEach = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/instance/for-each"));

var _qs = _interopRequireDefault(require("qs"));

const parseBody = rawBody => {
  if (typeof rawBody === 'string') {
    return {
      body: rawBody,
      isBase64Encoded: false
    };
  }

  if (rawBody instanceof Buffer) {
    return {
      body: rawBody.toString('base64'),
      isBase64Encoded: true
    };
  }

  return {
    body: '',
    isBase64Encoded: false
  };
};

exports.parseBody = parseBody;

const lambdaEventForExpressRequest = request => {
  return {
    httpMethod: request.method,
    headers: request.headers,
    path: request.path,
    queryStringParameters: _qs.default.parse(request.url.split(/\?(.+)/)[1]),
    requestContext: {
      identity: {
        sourceIp: request.ip
      }
    },
    ...parseBody(request.body) // adds `body` and `isBase64Encoded`

  };
};

const expressResponseForLambdaResult = (expressResFn, lambdaResult) => {
  const {
    statusCode = 200,
    headers,
    body = ''
  } = lambdaResult;

  if (headers) {
    var _context;

    (0, _forEach.default)(_context = (0, _keys.default)(headers)).call(_context, headerName => {
      const headerValue = headers[headerName];
      expressResFn.setHeader(headerName, headerValue);
    });
  }

  expressResFn.statusCode = statusCode; // The AWS lambda docs specify that the response object must be
  // compatible with `JSON.stringify`, but the type definition specifices that
  // it must be a string.

  return expressResFn.end(typeof body === 'string' ? body : (0, _stringify.default)(body));
};

const expressResponseForLambdaError = (expressResFn, error) => {
  console.error(error);
  expressResFn.status(500).send(error);
};

const requestHandler = async (req, res, lambdaFunction) => {
  const {
    routeName
  } = req.params;
  const {
    handler
  } = lambdaFunction;

  if (typeof handler !== 'function') {
    const errorMessage = `"${routeName}" does not export a function named "handler"`;
    console.error(errorMessage);
    return res.status(500).send(errorMessage);
  } // We take the express request object and convert it into a lambda function event.


  const event = lambdaEventForExpressRequest(req);

  const handlerCallback = expressResFn => (error, lambdaResult) => {
    if (error) {
      return expressResponseForLambdaError(expressResFn, error);
    }

    return expressResponseForLambdaResult(expressResFn, lambdaResult);
  }; // Execute the lambda function.
  // https://docs.aws.amazon.com/lambda/latest/dg/nodejs-prog-model-handler.html


  const handlerPromise = handler(event, {}, // TODO: Add support for context: https://github.com/DefinitelyTyped/DefinitelyTyped/blob/0bb210867d16170c4a08d9ce5d132817651a0f80/types/aws-lambda/index.d.ts#L443-L467
  handlerCallback(res)); // In this case the handlerCallback should not be called.

  if (handlerPromise && typeof handlerPromise.then === 'function') {
    try {
      const lambaResponse = await handlerPromise;
      return expressResponseForLambdaResult(res, lambaResponse);
    } catch (error) {
      return expressResponseForLambdaError(res, error);
    }
  }
};

exports.requestHandler = requestHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZXF1ZXN0SGFuZGxlcnMvYXdzTGFtYmRhLnRzIl0sIm5hbWVzIjpbInBhcnNlQm9keSIsInJhd0JvZHkiLCJib2R5IiwiaXNCYXNlNjRFbmNvZGVkIiwiQnVmZmVyIiwidG9TdHJpbmciLCJsYW1iZGFFdmVudEZvckV4cHJlc3NSZXF1ZXN0IiwicmVxdWVzdCIsImh0dHBNZXRob2QiLCJtZXRob2QiLCJoZWFkZXJzIiwicGF0aCIsInF1ZXJ5U3RyaW5nUGFyYW1ldGVycyIsInFzIiwicGFyc2UiLCJ1cmwiLCJzcGxpdCIsInJlcXVlc3RDb250ZXh0IiwiaWRlbnRpdHkiLCJzb3VyY2VJcCIsImlwIiwiZXhwcmVzc1Jlc3BvbnNlRm9yTGFtYmRhUmVzdWx0IiwiZXhwcmVzc1Jlc0ZuIiwibGFtYmRhUmVzdWx0Iiwic3RhdHVzQ29kZSIsImhlYWRlck5hbWUiLCJoZWFkZXJWYWx1ZSIsInNldEhlYWRlciIsImVuZCIsImV4cHJlc3NSZXNwb25zZUZvckxhbWJkYUVycm9yIiwiZXJyb3IiLCJjb25zb2xlIiwic3RhdHVzIiwic2VuZCIsInJlcXVlc3RIYW5kbGVyIiwicmVxIiwicmVzIiwibGFtYmRhRnVuY3Rpb24iLCJyb3V0ZU5hbWUiLCJwYXJhbXMiLCJoYW5kbGVyIiwiZXJyb3JNZXNzYWdlIiwiZXZlbnQiLCJoYW5kbGVyQ2FsbGJhY2siLCJoYW5kbGVyUHJvbWlzZSIsInRoZW4iLCJsYW1iYVJlc3BvbnNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFQTs7QUFFTyxNQUFNQSxTQUFTLEdBQUlDLE9BQUQsSUFBOEI7QUFDckQsTUFBSSxPQUFPQSxPQUFQLEtBQW1CLFFBQXZCLEVBQWlDO0FBQy9CLFdBQU87QUFBRUMsTUFBQUEsSUFBSSxFQUFFRCxPQUFSO0FBQWlCRSxNQUFBQSxlQUFlLEVBQUU7QUFBbEMsS0FBUDtBQUNEOztBQUNELE1BQUlGLE9BQU8sWUFBWUcsTUFBdkIsRUFBK0I7QUFDN0IsV0FBTztBQUFF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QUE2QixDQUFDUCxZQUFELEVBQWVRLEtBQWYsQ0FBcEM7QUFDRDs7QUFDRCxXQUFPVCw4QkFBOEIsQ0FBQ0MsWUFBRCxFQUFlQyxZQUFmLENBQXJDO0FBQ0QsR0FSRCxDQWRHLENBd0JIO0FBQ0E7OztBQUNBLFFBQU1xQixjQUFjLEdBQUdKLE9BQU8sQ0FDNUJFLEtBRDRCLEVBRTVCLEVBRjRCLEVBRXhCO0FBQ0pDLEVBQUFBLGVBQWUsQ0FBQ1AsR0FBRCxDQUhhLENBQTlCLENBMUJHLENBZ0NIOztBQUNBLE1BQUlRLGNBQWMsSUFBSSxPQUFPQSxjQUFjLENBQUNDLElBQXRCLEtBQStCLFVBQXJELEVBQWlFO0FBQy9ELFFBQUk7QUFDRixZQUFNQyxhQUFhLEdBQUcsTUFBTUYsY0FBNUI7QUFDQSxhQUFPdkIsOEJBQThCLENBQUNlLEdBQUQsRUFBTVUsYUFBTixDQUFyQztBQUNELEtBSEQsQ0FHRSxPQUFPaEIsS0FBUCxFQUFjO0FBQ2QsYUFBT0QsNkJBQTZCLENBQUNPLEdBQUQsRUFBTU4sS0FBTixDQUFwQztBQUNEO0FBQ0Y7QUFDRixDQTdDTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgQVBJR2F0ZXdheVByb3h5UmVzdWx0LCBBUElHYXRld2F5UHJveHlFdmVudCB9IGZyb20gJ2F3cy1sYW1iZGEnXG5pbXBvcnQgdHlwZSB7IFJlc3BvbnNlLCBSZXF1ZXN0IH0gZnJvbSAnZXhwcmVzcydcbmltcG9ydCBxcyBmcm9tICdxcydcblxuZXhwb3J0IGNvbnN0IHBhcnNlQm9keSA9IChyYXdCb2R5OiBzdHJpbmcgfCBCdWZmZXIpID0+IHtcbiAgaWYgKHR5cGVvZiByYXdCb2R5ID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiB7IGJvZHk6IHJhd0JvZHksIGlzQmFzZTY0RW5jb2RlZDogZmFsc2UgfVxuICB9XG4gIGlmIChyYXdCb2R5IGluc3RhbmNlb2YgQnVmZmVyKSB7XG4gICAgcmV0dXJuIHsgYm9keTogcmF3Qm9keS50b1N0cmluZygnYmFzZTY0JyksIGlzQmFzZTY0RW5jb2RlZDogdHJ1ZSB9XG4gIH1cbiAgcmV0dXJuIHsgYm9keTogJycsIGlzQmFzZTY0RW5jb2RlZDogZmFsc2UgfVxufVxuXG5jb25zdCBsYW1iZGFFdmVudEZvckV4cHJlc3NSZXF1ZXN0ID0gKFxuICByZXF1ZXN0OiBSZXF1ZXN0XG4pOiBBUElHYXRld2F5UHJveHlFdmVudCA9PiB7XG4gIHJldHVybiB7XG4gICAgaHR0cE1ldGhvZDogcmVxdWVzdC5tZXRob2QsXG4gICAgaGVhZGVyczogcmVxdWVzdC5oZWFkZXJzLFxuICAgIHBhdGg6IHJlcXVlc3QucGF0aCxcbiAgICBxdWVyeVN0cmluZ1BhcmFtZXRlcnM6IHFzLnBhcnNlKHJlcXVlc3QudXJsLnNwbGl0KC9cXD8oLispLylbMV0pLFxuICAgIHJlcXVlc3RDb250ZXh0OiB7XG4gICAgICBpZGVudGl0eToge1xuICAgICAgICBzb3VyY2VJcDogcmVxdWVzdC5pcCxcbiAgICAgIH0sXG4gICAgfSxcbiAgICAuLi5wYXJzZUJvZHkocmVxdWVzdC5ib2R5KSwgLy8gYWRkcyBgYm9keWAgYW5kIGBpc0Jhc2U2NEVuY29kZWRgXG4gIH0gYXMgQVBJR2F0ZXdheVByb3h5RXZlbnRcbn1cblxuY29uc3QgZXhwcmVzc1Jlc3BvbnNlRm9yTGFtYmRhUmVzdWx0ID0gKFxuICBleHByZXNzUmVzRm46IFJlc3BvbnNlLFxuICBsYW1iZGFSZXN1bHQ6IEFQSUdhdGV3YXlQcm94eVJlc3VsdFxuKSA9PiB7XG4gIGNvbnN0IHsgc3RhdHVzQ29kZSA9IDIwMCwgaGVhZGVycywgYm9keSA9ICcnIH0gPSBsYW1iZGFSZXN1bHRcbiAgaWYgKGhlYWRlcnMpIHtcbiAgICBPYmplY3Qua2V5cyhoZWFkZXJzKS5mb3JFYWNoKChoZWFkZXJOYW1lKSA9PiB7XG4gICAgICBjb25zdCBoZWFkZXJWYWx1ZTogYW55ID0gaGVhZGVyc1toZWFkZXJOYW1lXVxuICAgICAgZXhwcmVzc1Jlc0ZuLnNldEhlYWRlcihoZWFkZXJOYW1lLCBoZWFkZXJWYWx1ZSlcbiAgICB9KVxuICB9XG4gIGV4cHJlc3NSZXNGbi5zdGF0dXNDb2RlID0gc3RhdHVzQ29kZVxuICAvLyBUaGUgQVdTIGxhbWJkYSBkb2NzIHNwZWNpZnkgdGhhdCB0aGUgcmVzcG9uc2Ugb2JqZWN0IG11c3QgYmVcbiAgLy8gY29tcGF0aWJsZSB3aXRoIGBKU09OLnN0cmluZ2lmeWAsIGJ1dCB0aGUgdHlwZSBkZWZpbml0aW9uIHNwZWNpZmljZXMgdGhhdFxuICAvLyBpdCBtdXN0IGJlIGEgc3RyaW5nLlxuICByZXR1cm4gZXhwcmVzc1Jlc0ZuLmVuZChcbiAgICB0eXBlb2YgYm9keSA9PT0gJ3N0cmluZycgPyBib2R5IDogSlNPTi5zdHJpbmdpZnkoYm9keSlcbiAgKVxufVxuXG5jb25zdCBleHByZXNzUmVzcG9uc2VGb3JMYW1iZGFFcnJvciA9IChcbiAgZXhwcmVzc1Jlc0ZuOiBSZXNwb25zZSxcbiAgZXJyb3I6IEVycm9yXG4pID0+IHtcbiAgY29uc29sZS5lcnJvcihlcnJvcilcbiAgZXhwcmVzc1Jlc0ZuLnN0YXR1cyg1MDApLnNlbmQoZXJyb3IpXG59XG5cbmV4cG9ydCBjb25zdCByZXF1ZXN0SGFuZGxlciA9IGFzeW5jIChcbiAgcmVxOiBSZXF1ZXN0LFxuICByZXM6IFJlc3BvbnNlLFxuICBsYW1iZGFGdW5jdGlvbj86IGFueVxuKSA9PiB7XG4gIGNvbnN0IHsgcm91dGVOYW1lIH0gPSByZXEucGFyYW1zXG5cbiAgY29uc3QgeyBoYW5kbGVyIH0gPSBsYW1iZGFGdW5jdGlvblxuXG4gIGlmICh0eXBlb2YgaGFuZGxlciAhPT0gJ2Z1bmN0aW9uJykge1xuICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGBcIiR7cm91dGVOYW1lfVwiIGRvZXMgbm90IGV4cG9ydCBhIGZ1bmN0aW9uIG5hbWVkIFwiaGFuZGxlclwiYFxuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3JNZXNzYWdlKVxuICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuc2VuZChlcnJvck1lc3NhZ2UpXG4gIH1cblxuICAvLyBXZSB0YWtlIHRoZSBleHByZXNzIHJlcXVlc3Qgb2JqZWN0IGFuZCBjb252ZXJ0IGl0IGludG8gYSBsYW1iZGEgZnVuY3Rpb24gZXZlbnQuXG4gIGNvbnN0IGV2ZW50ID0gbGFtYmRhRXZlbnRGb3JFeHByZXNzUmVxdWVzdChyZXEpXG5cbiAgY29uc3QgaGFuZGxlckNhbGxiYWNrID0gKGV4cHJlc3NSZXNGbjogUmVzcG9uc2UpID0+IChcbiAgICBlcnJvcjogRXJyb3IsXG4gICAgbGFtYmRhUmVzdWx0OiBBUElHYXRld2F5UHJveHlSZXN1bHRcbiAgKSA9PiB7XG4gICAgaWYgKGVycm9yKSB7XG4gICAgICByZXR1cm4gZXhwcmVzc1Jlc3BvbnNlRm9yTGFtYmRhRXJyb3IoZXhwcmVzc1Jlc0ZuLCBlcnJvcilcbiAgICB9XG4gICAgcmV0dXJuIGV4cHJlc3NSZXNwb25zZUZvckxhbWJkYVJlc3VsdChleHByZXNzUmVzRm4sIGxhbWJkYVJlc3VsdClcbiAgfVxuXG4gIC8vIEV4ZWN1dGUgdGhlIGxhbWJkYSBmdW5jdGlvbi5cbiAgLy8gaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2xhbWJkYS9sYXRlc3QvZGcvbm9kZWpzLXByb2ctbW9kZWwtaGFuZGxlci5odG1sXG4gIGNvbnN0IGhhbmRsZXJQcm9taXNlID0gaGFuZGxlcihcbiAgICBldmVudCxcbiAgICB7fSwgLy8gVE9ETzogQWRkIHN1cHBvcnQgZm9yIGNvbnRleHQ6IGh0dHBzOi8vZ2l0aHViLmNvbS9EZWZpbml0ZWx5VHlwZWQvRGVmaW5pdGVseVR5cGVkL2Jsb2IvMGJiMjEwODY3ZDE2MTcwYzRhMDhkOWNlNWQxMzI4MTc2NTFhMGY4MC90eXBlcy9hd3MtbGFtYmRhL2luZGV4LmQudHMjTDQ0My1MNDY3XG4gICAgaGFuZGxlckNhbGxiYWNrKHJlcylcbiAgKVxuXG4gIC8vIEluIHRoaXMgY2FzZSB0aGUgaGFuZGxlckNhbGxiYWNrIHNob3VsZCBub3QgYmUgY2FsbGVkLlxuICBpZiAoaGFuZGxlclByb21pc2UgJiYgdHlwZW9mIGhhbmRsZXJQcm9taXNlLnRoZW4gPT09ICdmdW5jdGlvbicpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgbGFtYmFSZXNwb25zZSA9IGF3YWl0IGhhbmRsZXJQcm9taXNlXG4gICAgICByZXR1cm4gZXhwcmVzc1Jlc3BvbnNlRm9yTGFtYmRhUmVzdWx0KHJlcywgbGFtYmFSZXNwb25zZSlcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIGV4cHJlc3NSZXNwb25zZUZvckxhbWJkYUVycm9yKHJlcywgZXJyb3IpXG4gICAgfVxuICB9XG59XG4iXX0=