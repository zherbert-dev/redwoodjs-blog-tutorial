"use strict";

var _interopRequireWildcard = require("@babel/runtime-corejs3/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js/object/define-property");

_Object$defineProperty(exports, "__esModule", {
  value: true
});

exports.makeMergedSchema = void 0;

var _values = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/object/values"));

var _includes = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/instance/includes"));

var _startsWith = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/instance/starts-with"));

var _filter = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/instance/filter"));

var _map = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/instance/map"));

var _keys = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/object/keys"));

var _reduce = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/instance/reduce"));

var _apolloServerLambda = require("apollo-server-lambda");

var _mergeGraphqlSchemas = require("merge-graphql-schemas");

var _lodash = _interopRequireDefault(require("lodash.merge"));

var _lodash2 = _interopRequireDefault(require("lodash.omitby"));

var rootSchema = _interopRequireWildcard(require("./rootSchema"));

const mapFieldsToService = ({
  fields = {},
  resolvers: unmappedResolvers,
  services
}) => {
  var _context;

  return (0, _reduce.default)(_context = (0, _keys.default)(fields)).call(_context, (resolvers, name) => {
    // Does the function already exist in the resolvers from the schema definition?
    if (resolvers === null || resolvers === void 0 ? void 0 : resolvers[name]) {
      return resolvers;
    } // Does a function exist in the service?


    if (services === null || services === void 0 ? void 0 : services[name]) {
      return { ...resolvers,
        // Map the arguments from GraphQL to an ordinary function a service would
        // expect.
        [name]: (root, args, context, info) => services[name](args, {
          root,
          context,
          info
        })
      };
    }

    return resolvers;
  }, unmappedResolvers);
};
/**
 * This iterates over all the schemas definitions and figures out which resolvers
 * are missing, it then tries to add the missing resolvers from the corresponding
 * service.
 */


const mergeResolversWithServices = ({
  schema,
  resolvers,
  services
}) => {
  var _context2, _context3, _context4, _context5;

  const mergedServices = (0, _lodash.default)({}, ...(0, _map.default)(_context2 = (0, _keys.default)(services)).call(_context2, name => services[name])); // Get a list of types that have fields.
  // TODO: Figure out if this would interfere with other types: Interface types, etc.`

  const typesWithFields = (0, _map.default)(_context3 = (0, _filter.default)(_context4 = (0, _filter.default)(_context5 = (0, _keys.default)(schema.getTypeMap())).call(_context5, name => !(0, _startsWith.default)(name).call(name, '_'))).call(_context4, name => typeof schema.getType(name).getFields !== 'undefined')).call(_context3, name => {
    return schema.getType(name);
  });
  const mappedResolvers = (0, _reduce.default)(typesWithFields).call(typesWithFields, (acc, type) => {
    var _context6;

    // Services export Query and Mutation field resolvers as named exports,
    // but other GraphQLObjectTypes are exported as an object that are named
    // after the type.
    // Example: export const MyType = { field: () => {} }
    let servicesForType = mergedServices;

    if (!(0, _includes.default)(_context6 = ['Query', 'Mutation']).call(_context6, type.name)) {
      servicesForType = mergedServices === null || mergedServices === void 0 ? void 0 : mergedServices[type.name];
    }

    return { ...acc,
      [type.name]: mapFieldsToService({
        fields: type.getFields(),
        resolvers: resolvers === null || resolvers === void 0 ? void 0 : resolvers[type.name],
        services: servicesForType
      })
    };
  }, {});
  return (0, _lodash2.default)({ ...resolvers,
    ...mappedResolvers
  }, v => typeof v === 'undefined');
};

const mergeResolvers = schemas => {
  var _context7;

  return (0, _lodash2.default)((0, _lodash.default)({}, ...[rootSchema.resolvers, ...(0, _map.default)(_context7 = (0, _values.default)(schemas)).call(_context7, ({
    resolvers
  }) => resolvers)]), v => typeof v === 'undefined');
};
/**
 * Merge GraphQL typeDefs and resolvers into a single schema.
 *
 * @example
 * ```js
 * const schemas = importAll('api', 'graphql')
 * const services = importAll('api', 'services')
 *
 * const schema = makeMergedSchema({
 *  schema,
 *  services: makeServices({ services }),
 * })
 * ```
 */


const makeMergedSchema = ({
  schemas,
  services,
  schemaDirectives
}) => {
  var _context8;

  const typeDefs = (0, _mergeGraphqlSchemas.mergeTypes)([rootSchema.schema, ...(0, _map.default)(_context8 = (0, _values.default)(schemas)).call(_context8, ({
    schema
  }) => schema)], {
    all: true
  });
  const schema = (0, _apolloServerLambda.makeExecutableSchema)({
    typeDefs,
    schemaDirectives
  });
  const resolvers = mergeResolversWithServices({
    schema,
    resolvers: mergeResolvers(schemas),
    services
  });
  (0, _apolloServerLambda.addResolveFunctionsToSchema)({
    schema,
    resolvers
  });
  return schema;
};

exports.makeMergedSchema = makeMergedSchema;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYWtlTWVyZ2VkU2NoZW1hL21ha2VNZXJnZWRTY2hlbWEuanMiXSwibmFtZXMiOlsibWFwRmllbGRzVG9TZXJ2aWNlIiwiZmllbGRzIiwicmVzb2x2ZXJzIiwidW5tYXBwZWRSZXNvbHZlcnMiLCJzZXJ2aWNlcyIsIm5hbWUiLCJyb290IiwiYXJncyIsImNvbnRleHQiLCJpbmZvIiwibWVyZ2VSZXNvbHZlcnNXaXRoU2VydmljZXMiLCJzY2hlbWEiLCJtZXJnZWRTZXJ2aWNlcyIsInR5cGVzV2l0aEZpZWxkcyIsImdldFR5cGVNYXAiLCJnZXRUeXBlIiwiZ2V0RmllbGRzIiwibWFwcGVkUmVzb2x2ZXJzIiwiYWNjIiwidHlwZSIsInNlcnZpY2VzRm9yVHlwZSIsInYiLCJtZXJnZVJlc29sdmVycyIsInNjaGVtYXMiLCJyb290U2NoZW1hIiwibWFrZU1lcmdlZFNjaGVtYSIsInNjaGVtYURpcmVjdGl2ZXMiLCJ0eXBlRGVmcyIsImFsbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUlBOztBQUNBOztBQUNBOztBQUVBOztBQUVBLE1BQU1BLGtCQUFrQixHQUFHLENBQUM7QUFDMUJDLEVBQUFBLE1BQU0sR0FBRyxFQURpQjtBQUUxQkMsRUFBQUEsU0FBUyxFQUFFQyxpQkFGZTtBQUcxQkMsRUFBQUE7QUFIMEIsQ0FBRDtBQUFBOztBQUFBLFNBS3pCLG1EQUFZSCxNQUFaLGtCQUEyQixDQUFDQyxTQUFELEVBQVlHLElBQVosS0FBcUI7QUFDOUM7QUFDQSxRQUFJSCxTQUFKLGFBQUlBLFNBQUosdUJBQUlBLFNBQVMsQ0FBR0csSUFBSCxDQUFiLEVBQXVCO0FBQ3JCLGFBQU9ILFNBQVA7QUFDRCxLQUo2QyxDQU05Qzs7O0FBQ0EsUUFBSUUsUUFBSixhQUFJQSxRQUFKLHVCQUFJQSxRQUFRLENBQUdDLElBQUgsQ0FBWixFQUFzQjtBQUNwQixhQUFPLEVBQ0wsR0FBR0gsU0FERTtBQUVMO0FBQ0E7QUFD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USxHQUFHLHFDQUNmLENBQUNILFVBQVUsQ0FBQ2IsTUFBWixFQUFvQixHQUFHLG1EQUFjWSxPQUFkLG1CQUEyQixDQUFDO0FBQUVaLElBQUFBO0FBQUYsR0FBRCxLQUFnQkEsTUFBM0MsQ0FBdkIsQ0FEZSxFQUVmO0FBQUVpQixJQUFBQSxHQUFHLEVBQUU7QUFBUCxHQUZlLENBQWpCO0FBS0EsUUFBTWpCLE1BQU0sR0FBRyw4Q0FBcUI7QUFDbENnQixJQUFBQSxRQURrQztBQUVsQ0QsSUFBQUE7QUFGa0MsR0FBckIsQ0FBZjtBQUtBLFFBQU14QixTQUFTLEdBQUdRLDBCQUEwQixDQUFDO0FBQzNDQyxJQUFBQSxNQUQyQztBQUUzQ1QsSUFBQUEsU0FBUyxFQUFFb0IsY0FBYyxDQUFDQyxPQUFELENBRmtCO0FBRzNDbkIsSUFBQUE7QUFIMkMsR0FBRCxDQUE1QztBQUtBLHVEQUE0QjtBQUFFTyxJQUFBQSxNQUFGO0FBQVVULElBQUFBO0FBQVYsR0FBNUI7QUFFQSxTQUFPUyxNQUFQO0FBQ0QsQ0FuQk0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBhZGRSZXNvbHZlRnVuY3Rpb25zVG9TY2hlbWEsXG4gIG1ha2VFeGVjdXRhYmxlU2NoZW1hLFxufSBmcm9tICdhcG9sbG8tc2VydmVyLWxhbWJkYSdcbmltcG9ydCB7IG1lcmdlVHlwZXMgfSBmcm9tICdtZXJnZS1ncmFwaHFsLXNjaGVtYXMnXG5pbXBvcnQgbWVyZ2UgZnJvbSAnbG9kYXNoLm1lcmdlJ1xuaW1wb3J0IG9taXRCeSBmcm9tICdsb2Rhc2gub21pdGJ5J1xuXG5pbXBvcnQgKiBhcyByb290U2NoZW1hIGZyb20gJy4vcm9vdFNjaGVtYSdcblxuY29uc3QgbWFwRmllbGRzVG9TZXJ2aWNlID0gKHtcbiAgZmllbGRzID0ge30sXG4gIHJlc29sdmVyczogdW5tYXBwZWRSZXNvbHZlcnMsXG4gIHNlcnZpY2VzLFxufSkgPT5cbiAgT2JqZWN0LmtleXMoZmllbGRzKS5yZWR1Y2UoKHJlc29sdmVycywgbmFtZSkgPT4ge1xuICAgIC8vIERvZXMgdGhlIGZ1bmN0aW9uIGFscmVhZHkgZXhpc3QgaW4gdGhlIHJlc29sdmVycyBmcm9tIHRoZSBzY2hlbWEgZGVmaW5pdGlvbj9cbiAgICBpZiAocmVzb2x2ZXJzPy5bbmFtZV0pIHtcbiAgICAgIHJldHVybiByZXNvbHZlcnNcbiAgICB9XG5cbiAgICAvLyBEb2VzIGEgZnVuY3Rpb24gZXhpc3QgaW4gdGhlIHNlcnZpY2U/XG4gICAgaWYgKHNlcnZpY2VzPy5bbmFtZV0pIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnJlc29sdmVycyxcbiAgICAgICAgLy8gTWFwIHRoZSBhcmd1bWVudHMgZnJvbSBHcmFwaFFMIHRvIGFuIG9yZGluYXJ5IGZ1bmN0aW9uIGEgc2VydmljZSB3b3VsZFxuICAgICAgICAvLyBleHBlY3QuXG4gICAgICAgIFtuYW1lXTogKHJvb3QsIGFyZ3MsIGNvbnRleHQsIGluZm8pID0+XG4gICAgICAgICAgc2VydmljZXNbbmFtZV0oYXJncywgeyByb290LCBjb250ZXh0LCBpbmZvIH0pLFxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiByZXNvbHZlcnNcbiAgfSwgdW5tYXBwZWRSZXNvbHZlcnMpXG5cbi8qKlxuICogVGhpcyBpdGVyYXRlcyBvdmVyIGFsbCB0aGUgc2NoZW1hcyBkZWZpbml0aW9ucyBhbmQgZmlndXJlcyBvdXQgd2hpY2ggcmVzb2x2ZXJzXG4gKiBhcmUgbWlzc2luZywgaXQgdGhlbiB0cmllcyB0byBhZGQgdGhlIG1pc3NpbmcgcmVzb2x2ZXJzIGZyb20gdGhlIGNvcnJlc3BvbmRpbmdcbiAqIHNlcnZpY2UuXG4gKi9cbmNvbnN0IG1lcmdlUmVzb2x2ZXJzV2l0aFNlcnZpY2VzID0gKHsgc2NoZW1hLCByZXNvbHZlcnMsIHNlcnZpY2VzIH0pID0+IHtcbiAgY29uc3QgbWVyZ2VkU2VydmljZXMgPSBtZXJnZShcbiAgICB7fSxcbiAgICAuLi5PYmplY3Qua2V5cyhzZXJ2aWNlcykubWFwKChuYW1lKSA9PiBzZXJ2aWNlc1tuYW1lXSlcbiAgKVxuXG4gIC8vIEdldCBhIGxpc3Qgb2YgdHlwZXMgdGhhdCBoYXZlIGZpZWxkcy5cbiAgLy8gVE9ETzogRmlndXJlIG91dCBpZiB0aGlzIHdvdWxkIGludGVyZmVyZSB3aXRoIG90aGVyIHR5cGVzOiBJbnRlcmZhY2UgdHlwZXMsIGV0Yy5gXG4gIGNvbnN0IHR5cGVzV2l0aEZpZWxkcyA9IE9iamVjdC5rZXlzKHNjaGVtYS5nZXRUeXBlTWFwKCkpXG4gICAgLmZpbHRlcigobmFtZSkgPT4gIW5hbWUuc3RhcnRzV2l0aCgnXycpKVxuICAgIC5maWx0ZXIoKG5hbWUpID0+IHR5cGVvZiBzY2hlbWEuZ2V0VHlwZShuYW1lKS5nZXRGaWVsZHMgIT09ICd1bmRlZmluZWQnKVxuICAgIC5tYXAoKG5hbWUpID0+IHtcbiAgICAgIHJldHVybiBzY2hlbWEuZ2V0VHlwZShuYW1lKVxuICAgIH0pXG5cbiAgY29uc3QgbWFwcGVkUmVzb2x2ZXJzID0gdHlwZXNXaXRoRmllbGRzLnJlZHVjZSgoYWNjLCB0eXBlKSA9PiB7XG4gICAgLy8gU2VydmljZXMgZXhwb3J0IFF1ZXJ5IGFuZCBNdXRhdGlvbiBmaWVsZCByZXNvbHZlcnMgYXMgbmFtZWQgZXhwb3J0cyxcbiAgICAvLyBidXQgb3RoZXIgR3JhcGhRTE9iamVjdFR5cGVzIGFyZSBleHBvcnRlZCBhcyBhbiBvYmplY3QgdGhhdCBhcmUgbmFtZWRcbiAgICAvLyBhZnRlciB0aGUgdHlwZS5cbiAgICAvLyBFeGFtcGxlOiBleHBvcnQgY29uc3QgTXlUeXBlID0geyBmaWVsZDogKCkgPT4ge30gfVxuICAgIGxldCBzZXJ2aWNlc0ZvclR5cGUgPSBtZXJnZWRTZXJ2aWNlc1xuICAgIGlmICghWydRdWVyeScsICdNdXRhdGlvbiddLmluY2x1ZGVzKHR5cGUubmFtZSkpIHtcbiAgICAgIHNlcnZpY2VzRm9yVHlwZSA9IG1lcmdlZFNlcnZpY2VzPy5bdHlwZS5uYW1lXVxuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICAuLi5hY2MsXG4gICAgICBbdHlwZS5uYW1lXTogbWFwRmllbGRzVG9TZXJ2aWNlKHtcbiAgICAgICAgZmllbGRzOiB0eXBlLmdldEZpZWxkcygpLFxuICAgICAgICByZXNvbHZlcnM6IHJlc29sdmVycz8uW3R5cGUubmFtZV0sXG4gICAgICAgIHNlcnZpY2VzOiBzZXJ2aWNlc0ZvclR5cGUsXG4gICAgICB9KSxcbiAgICB9XG4gIH0sIHt9KVxuXG4gIHJldHVybiBvbWl0QnkoXG4gICAge1xuICAgICAgLi4ucmVzb2x2ZXJzLFxuICAgICAgLi4ubWFwcGVkUmVzb2x2ZXJzLFxuICAgIH0sXG4gICAgKHYpID0+IHR5cGVvZiB2ID09PSAndW5kZWZpbmVkJ1xuICApXG59XG5cbmNvbnN0IG1lcmdlUmVzb2x2ZXJzID0gKHNjaGVtYXMpID0+XG4gIG9taXRCeShcbiAgICBtZXJnZShcbiAgICAgIHt9LFxuICAgICAgLi4uW1xuICAgICAgICByb290U2NoZW1hLnJlc29sdmVycyxcbiAgICAgICAgLi4uT2JqZWN0LnZhbHVlcyhzY2hlbWFzKS5tYXAoKHsgcmVzb2x2ZXJzIH0pID0+IHJlc29sdmVycyksXG4gICAgICBdXG4gICAgKSxcbiAgICAodikgPT4gdHlwZW9mIHYgPT09ICd1bmRlZmluZWQnXG4gIClcblxuLyoqXG4gKiBNZXJnZSBHcmFwaFFMIHR5cGVEZWZzIGFuZCByZXNvbHZlcnMgaW50byBhIHNpbmdsZSBzY2hlbWEuXG4gKlxuICogQGV4YW1wbGVcbiAqIGBgYGpzXG4gKiBjb25zdCBzY2hlbWFzID0gaW1wb3J0QWxsKCdhcGknLCAnZ3JhcGhxbCcpXG4gKiBjb25zdCBzZXJ2aWNlcyA9IGltcG9ydEFsbCgnYXBpJywgJ3NlcnZpY2VzJylcbiAqXG4gKiBjb25zdCBzY2hlbWEgPSBtYWtlTWVyZ2VkU2NoZW1hKHtcbiAqICBzY2hlbWEsXG4gKiAgc2VydmljZXM6IG1ha2VTZXJ2aWNlcyh7IHNlcnZpY2VzIH0pLFxuICogfSlcbiAqIGBgYFxuICovXG5leHBvcnQgY29uc3QgbWFrZU1lcmdlZFNjaGVtYSA9ICh7IHNjaGVtYXMsIHNlcnZpY2VzLCBzY2hlbWFEaXJlY3RpdmVzIH0pID0+IHtcbiAgY29uc3QgdHlwZURlZnMgPSBtZXJnZVR5cGVzKFxuICAgIFtyb290U2NoZW1hLnNjaGVtYSwgLi4uT2JqZWN0LnZhbHVlcyhzY2hlbWFzKS5tYXAoKHsgc2NoZW1hIH0pID0+IHNjaGVtYSldLFxuICAgIHsgYWxsOiB0cnVlIH1cbiAgKVxuXG4gIGNvbnN0IHNjaGVtYSA9IG1ha2VFeGVjdXRhYmxlU2NoZW1hKHtcbiAgICB0eXBlRGVmcyxcbiAgICBzY2hlbWFEaXJlY3RpdmVzLFxuICB9KVxuXG4gIGNvbnN0IHJlc29sdmVycyA9IG1lcmdlUmVzb2x2ZXJzV2l0aFNlcnZpY2VzKHtcbiAgICBzY2hlbWEsXG4gICAgcmVzb2x2ZXJzOiBtZXJnZVJlc29sdmVycyhzY2hlbWFzKSxcbiAgICBzZXJ2aWNlcyxcbiAgfSlcbiAgYWRkUmVzb2x2ZUZ1bmN0aW9uc1RvU2NoZW1hKHsgc2NoZW1hLCByZXNvbHZlcnMgfSlcblxuICByZXR1cm4gc2NoZW1hXG59XG4iXX0=